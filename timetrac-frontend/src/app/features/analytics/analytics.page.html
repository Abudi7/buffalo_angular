<!-- Analytics Dashboard Template -->
<ion-content>
  <!-- Header -->
  <ion-header [translucent]="true">
    <ion-toolbar>
      <ion-buttons slot="start">
        <ion-back-button defaultHref="/home"></ion-back-button>
      </ion-buttons>
      <ion-title>{{ t('analytics.title') }}</ion-title>
    </ion-toolbar>
  </ion-header>

  <!-- Pull to Refresh -->
  <ion-refresher slot="fixed" (ionRefresh)="loadAnalytics($event)">
    <ion-refresher-content></ion-refresher-content>
  </ion-refresher>

  <!-- Date Range Selector -->
  <ion-card>
    <ion-card-header>
      <ion-card-title>{{ t('analytics.dateRange') }}</ion-card-title>
    </ion-card-header>
    <ion-card-content>
      <ion-segment [(ngModel)]="selectedRange" (ionChange)="onRangeChange()">
        <ion-segment-button value="week">
          <ion-label>{{ t('analytics.week') }}</ion-label>
        </ion-segment-button>
        <ion-segment-button value="month">
          <ion-label>{{ t('analytics.month') }}</ion-label>
        </ion-segment-button>
        <ion-segment-button value="quarter">
          <ion-label>{{ t('analytics.quarter') }}</ion-label>
        </ion-segment-button>
        <ion-segment-button value="year">
          <ion-label>{{ t('analytics.year') }}</ion-label>
        </ion-segment-button>
      </ion-segment>
      
      <!-- Custom Date Range -->
      <div class="custom-date-range" *ngIf="selectedRange === 'custom'">
        <ion-item>
          <ion-label>{{ t('analytics.startDate') }}</ion-label>
          <ion-datetime-button datetime="start-datetime"></ion-datetime-button>
        </ion-item>
        <ion-item>
          <ion-label>{{ t('analytics.endDate') }}</ion-label>
          <ion-datetime-button datetime="end-datetime"></ion-datetime-button>
        </ion-item>
      </div>
    </ion-card-content>
  </ionion-card>

  <!-- Key Metrics -->
  <ion-card>
    <ion-card-header>
      <ion-card-title>{{ t('analytics.keyMetrics') }}</ion-card-title>
    </ion-card-header>
    <ion-card-content>
      <ion-grid>
        <ion-row>
          <ion-col size="6">
            <div class="metric-card">
              <div class="metric-value">{{ formatHours(totalHours) }}</div>
              <div class="metric-label">{{ t('analytics.totalTime') }}</div>
            </div>
          </ion-col>
          <ion-col size="6">
            <div class="metric-card">
              <div class="metric-value">{{ formatHours(averageDailyHours) }}</div>
              <div class="metric-label">{{ t('analytics.avgDaily') }}</div>
            </div>
          </ion-col>
        </ion-row>
        <ion-row>
          <ion-col size="6">
            <div class="metric-card">
              <div class="metric-value">{{ totalProjects }}</div>
              <div class="metric-label">{{ t('analytics.totalProjects') }}</div>
            </div>
          </ion-col>
          <ion-col size="6">
            <div class="metric-card">
              <div class="metric-value">{{ mostProductiveHour }}:00</div>
              <div class="metric-label">{{ t('analytics.mostProductiveHour') }}</div>
            </div>
          </ion-col>
        </ion-row>
      </ion-grid>
    </ion-card-content>
  </ion-card>

  <!-- Daily Time Tracking Chart -->
  <ion-card>
    <ion-card-header>
      <ion-card-title>{{ t('analytics.dailyTracking') }}</ion-card-title>
    </ion-card-header>
    <ion-card-content>
      <div class="chart-container">
        <canvas baseChart
                [data]="dailyChartData"
                [options]="lineChartOptions"
                type="line">
        </canvas>
      </div>
    </ion-card-content>
  </ion-card>

  <!-- Project Distribution -->
  <ion-card>
    <ion-card-header>
      <ion-card-title>{{ t('analytics.projectDistribution') }}</ion-card-title>
    </ion-card-header>
    <ion-card-content>
      <div class="chart-container">
        <canvas baseChart
                [data]="projectChartData"
                [options]="doughnutChartOptions"
                type="doughnut">
        </canvas>
      </div>
    </ion-card-content>
  </ion-card>

  <!-- Hourly Productivity -->
  <ion-card>
    <ion-card-header>
      <ion-card-title>{{ t('analytics.hourlyProductivity') }}</ion-card-title>
    </ion-card-header>
    <ion-card-content>
      <div class="chart-container">
        <canvas baseChart
                [data]="hourlyChartData"
                [options]="barChartOptions"
                type="bar">
        </canvas>
      </div>
    </ion-card-content>
  </ion-card>

  <!-- Weekly Comparison -->
  <ion-card>
    <ion-card-header>
      <ion-card-title>{{ t('analytics.weeklyComparison') }}</ion-card-title>
    </ion-card-header>
    <ion-card-content>
      <div class="chart-container">
        <canvas baseChart
                [data]="weeklyChartData"
                [options]="barChartOptions"
                type="bar">
        </canvas>
      </div>
    </ion-card-content>
  </ion-card>

  <!-- Insights -->
  <ion-card>
    <ion-card-header>
      <ion-card-title>{{ t('analytics.insights') }}</ion-card-title>
    </ion-card-header>
    <ion-card-content>
      <ion-item>
        <ion-icon name="trophy" slot="start" color="warning"></ion-icon>
        <ion-label>
          <h3>{{ t('analytics.mostProductiveDay') }}</h3>
          <p>{{ mostProductiveDay || t('analytics.noData') }}</p>
        </ion-label>
      </ion-item>
      
      <ion-item>
        <ion-icon name="star" slot="start" color="primary"></ion-icon>
        <ion-label>
          <h3>{{ t('analytics.topProject') }}</h3>
          <p>{{ topProject || t('analytics.noData') }}</p>
        </ion-label>
      </ion-item>
      
      <ion-item>
        <ion-icon name="time" slot="start" color="success"></ion-icon>
        <ion-label>
          <h3>{{ t('analytics.totalEntries') }}</h3>
          <p>{{ filteredEntries.length }} {{ t('analytics.entries') }}</p>
        </ion-label>
      </ion-item>
    </ion-card-content>
  </ion-card>

  <!-- Loading State -->
  <div *ngIf="loading" class="loading-container">
    <ion-skeleton-text animated style="width: 100%; height: 200px;"></ion-skeleton-text>
    <ion-skeleton-text animated style="width: 80%; height: 100px;"></ion-skeleton-text>
    <ion-skeleton-text animated style="width: 60%; height: 100px;"></ion-skeleton-text>
  </div>
</ion-content>

<!-- Date Time Modals -->
<ion-modal [keepContentsMounted]="true">
  <ng-template>
    <ion-datetime
      id="start-datetime"
      presentation="date"
      [value]="startDate"
      (ionChange)="startDate = $event.detail.value; onDateChange()">
    </ion-datetime>
  </ng-template>
</ion-modal>

<ion-modal [keepContentsMounted]="true">
  <ng-template>
    <ion-datetime
      id="end-datetime"
      presentation="date"
      [value]="endDate"
      (ionChange)="endDate = $event.detail.value; onDateChange()">
    </ion-datetime>
  </ng-template>
</ion-modal>
