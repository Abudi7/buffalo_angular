<ion-content class="home-bg animated-content" [fullscreen]="true">
  <!-- Pull to refresh -->
  <ion-refresher slot="fixed" (ionRefresh)="load($event)">
    <ion-refresher-content></ion-refresher-content>
  </ion-refresher>

  <!-- Animated Hero Section -->
  <div class="hero animated-hero">
    <div class="hero-background"></div>

    <div class="hero-content">
      <div class="left">
        <div class="title animated-title">{{ t('app_title') }}</div>
        <div class="subtitle animated-subtitle">
          {{ today | date:'EEEE, MMM d' }}
        </div>
        <div class="welcome-text animated-text">{{ t('welcome_message') }}</div>
      </div>
      <div class="right">
        <ion-segment
          value="en"
          (ionChange)="onLangChange($event)"
          class="animated-segment"
        >
          <ion-segment-button value="en">EN</ion-segment-button>
          <ion-segment-button value="ar">AR</ion-segment-button>
          <ion-segment-button value="de">DE</ion-segment-button>
        </ion-segment>
        <ion-button
          fill="clear"
          class="refresh animated-button"
          (click)="load()"
        >
          <ion-icon [name]="'refresh-outline'"></ion-icon>
          {{ t('refresh') }}
        </ion-button>
        <ion-button
          fill="outline"
          size="small"
          class="animated-button"
          (click)="exportCsv()"
        >
          {{ t('export_csv') }}
        </ion-button>
      </div>
    </div>
  </div>


  <!-- Animated Live Clock -->
  <div class="clock animated-clock" [class.pulsing]="!!runningEntry">
    <div class="clock-icon">
      <ion-icon [name]="'time-outline'"></ion-icon>
    </div>
    <span class="clock-time">{{ hhmmss(elapsedMs) }}</span>
  </div>

  <!-- Animated Controls + List -->
  <div class="controls animated-controls">
    <!-- Animated Control card -->
    <ion-card class="card control-card animated-card" [class.card-hover]="true">
      <ion-card-header>
        <ion-card-title>{{ t('track_time') }}</ion-card-title>
        <ion-card-subtitle
          >{{ t('select_project_tags_note_color') }}</ion-card-subtitle
        >
      </ion-card-header>

      <ion-card-content>
        <!-- Project + color -->
        <div class="row">
          <ion-select
            interface="popover"
            [(ngModel)]="selectedProject"
            class="wide"
          >
            <ion-select-option *ngFor="let p of projects" [value]="p"
              >{{ p }}</ion-select-option
            >
          </ion-select>

          <div class="color">
            <ion-icon [name]="'color-palette-outline'"></ion-icon>
            <input type="color" [(ngModel)]="color" />
          </div>
        </div>

        <!-- Location + Photo -->
        <div class="row" style="gap: 8px; margin: 8px 0">
          <ion-button size="small" (click)="getLocation()"
            >Use Location</ion-button
          >
          <ion-button size="small" (click)="addPhoto()">Add Photo</ion-button>
        </div>

        <!-- Tags -->
        <div class="tags-box">
          <div class="label">{{ t('tags') }}</div>
          <div class="tags">
            <ion-chip *ngFor="let t of tags">
              <ion-label>{{ t }}</ion-label>
              <ion-icon name="close" (click)="removeTag(t)"></ion-icon>
            </ion-chip>
            <input
              class="tag-input"
              placeholder="Add tag and press Enter"
              [(ngModel)]="tagInput"
              (keyup.enter)="addTag()"
            />
            <ion-button size="small" (click)="addTag()">+</ion-button>
          </div>
        </div>

        <!-- Note -->
        <div class="note-box">
          <div class="label">{{ t('note') }}</div>
          <ion-textarea
            autoGrow="true"
            [placeholder]="'What are you working on?'"
            [(ngModel)]="note"
          ></ion-textarea>
        </div>

        <!-- Actions -->
        <div class="actions">
          <ion-button
            size="large"
            color="success"
            (click)="start()"
            [disabled]="!!runningEntry"
          >
            <ion-icon slot="start" [name]="'play-circle-outline'"></ion-icon>
            {{ t('start') }}
          </ion-button>
          <ion-button
            size="large"
            color="danger"
            (click)="stop()"
            [disabled]="!runningEntry"
          >
            <ion-icon slot="start" [name]="'stop-circle-outline'"></ion-icon>
            {{ t('stop') }}
          </ion-button>
        </div>
      </ion-card-content>
    </ion-card>

    <!-- Animated Entries list -->
    <ion-card class="card list-card animated-card" [class.card-hover]="true">
      <ion-card-header>
        <ion-card-title class="animated-title"
          >{{ t('entries') }}</ion-card-title
        >
        <ion-card-subtitle class="animated-subtitle"
          >{{ t('newest_first') }}</ion-card-subtitle
        >
      </ion-card-header>

      <ion-card-content>
        <ng-container *ngIf="loading; else entriesTpl">
          <ion-item
            class="skeleton animated-skeleton"
            *ngFor="let i of [1,2,3]"
          >
            <ion-skeleton-text animated style="width: 60%"></ion-skeleton-text>
          </ion-item>
        </ng-container>

        <ng-template #entriesTpl>
          <div *ngIf="entries.length === 0" class="empty animated-empty">
            <ion-icon [name]="'document-text-outline'"></ion-icon>
            <p>{{ t('no_entries') }}</p>
          </div>

          <ion-list lines="inset" class="animated-list">
            <ion-item
              class="entry animated-entry"
              *ngFor="let e of entries; trackBy: trackById; let i = index"
              [style.animation-delay]="(i * 0.1) + 's'"
            >
              <div slot="start" class="dot" [style.background]="e.color"></div>
              <ion-label>
                <h3>
                  {{ e.project || 'No project' }}
                  <span class="pill" [style.border-color]="e.color">
                    {{ durationPretty(e) }}
                  </span>
                </h3>

                <p class="times">
                  {{ e.start_at | date:'short' }}
                  <ng-container *ngIf="e.end_at as end">
                    ‚Üí {{ end | date:'short' }}
                  </ng-container>
                </p>

                <div class="chips" *ngIf="e.tags?.length">
                  <ion-chip *ngFor="let t of e.tags"
                    ><ion-label>{{ t }}</ion-label></ion-chip
                  >
                </div>

                <div class="note" *ngIf="e.note">
                  <ion-icon [name]="'document-text-outline'"></ion-icon>
                  <span>{{ e.note }}</span>
                </div>
                <div
                  *ngIf="e.location_addr || (e.location_lat && e.location_lng)"
                  class="meta"
                >
                  üìç {{ e.location_addr || (e.location_lat + ', ' +
                  e.location_lng) }}
                </div>
                <div *ngIf="e.photo_data" class="meta">
                  <img
                    [src]="e.photo_data"
                    alt="photo"
                    style="max-width: 100%; border-radius: 8px; margin-top: 6px"
                  />
                </div>

                <p class="meta">
                  created: {{ e.created_at | date:'short' }} ¬∑ updated: {{
                  e.updated_at | date:'short' }}
                </p>
              </ion-label>
            </ion-item>
          </ion-list>
        </ng-template>
      </ion-card-content>
    </ion-card>
  </div>
</ion-content>
